name: Security Testing & SAST

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd Backend
          pip install -r requirements.txt
      
      - name: Run Safety Check
        run: |
          cd Backend
          pip install safety
          safety check --file requirements.txt --json > safety-report.json || true
          cat safety-report.json
      
      - name: Upload Safety Report
        uses: actions/upload-artifact@v3
        with:
          name: safety-report
          path: Backend/safety-report.json

  sast-scan:
    name: Static Application Security Testing
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Run Bandit SAST
        run: |
          pip install bandit
          bandit -r Backend/ -f json -o bandit-report.json || true
          bandit -r Backend/ -f txt
      
      - name: Upload Bandit Report
        uses: actions/upload-artifact@v3
        with:
          name: bandit-report
          path: bandit-report.json
      
      - name: Check for HIGH severity issues
        run: |
          # Fail the build if HIGH or CRITICAL issues found
          pip install jq
          HIGH_COUNT=$(jq '.results | map(select(.issue_severity == "HIGH" or .issue_severity == "CRITICAL")) | length' bandit-report.json)
          if [ "$HIGH_COUNT" -gt 0 ]; then
            echo "âŒ Found $HIGH_COUNT HIGH/CRITICAL security issues!"
            exit 1
          fi

  secret-scan:
    name: Secret Detection Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for better secret detection
      
      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

  security-tests:
    name: Run Security Test  Suite
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd Backend
          pip install -r requirements.txt
      
      - name: Run Security Tests
        env:
          SUPABASE_JWT_SECRET: test-secret-key-minimum-32-characters-long-for-testing-purposes
          REDIS_URL: redis://localhost:6379/0
          ENVIRONMENT: test
        run: |
          cd Backend
          pytest tests/security/ -v --tb=short --junit-xml=security-test-results.xml
      
      - name: Upload Test Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-test-results
          path: Backend/security-test-results.xml

  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Build Docker Image
        run: |
          docker build -t vaptiq-backend:test ./Backend
      
      - name: Run Trivy Container Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'vaptiq-backend:test'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python, javascript
          queries: security-extended
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, sast-scan, secret-scan, security-tests]
    if: always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3
      
      - name: Generate Security Summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scans Completed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependency Vulnerability Scan (Safety)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Static Application Security Testing (Bandit)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Secret Detection (TruffleHog)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security Test Suite" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Container Security Scan (Trivy)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CodeQL Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š View detailed reports in the artifacts section." >> $GITHUB_STEP_SUMMARY
